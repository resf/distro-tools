{% extends "admin_layout.jinja" %}

{% block admin_content %}
<div class="bx--grid">
    <div class="bx--row">
        <div class="bx--col">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                <h1 class="bx--type-expressive-heading-05">API Keys</h1>
                <bx-btn href="new">Create new API key</bx-btn>
            </div>

<bx-pagination page-size="{{ api_keys.size }}" start="{{ (api_keys.page-1) * api_keys.size }}" total="{{ api_keys.total }}">
  <bx-page-sizes-select slot="page-sizes-select">
    <option value="50">50</option>
  </bx-page-sizes-select>
  <bx-pages-select value="{{ api_keys.page - 1 }}" total="{{ api_keys_pages }}"></bx-pages-select>
</bx-pagination>

<bx-data-table>
  <bx-table>
    <bx-table-head>
      <bx-table-header-row>
        <bx-table-header-cell>Name</bx-table-header-cell>
        <bx-table-header-cell>Key Prefix</bx-table-header-cell>
        <bx-table-header-cell>Permissions</bx-table-header-cell>
        <bx-table-header-cell>Created</bx-table-header-cell>
        <bx-table-header-cell>Expires</bx-table-header-cell>
        <bx-table-header-cell>Last Used</bx-table-header-cell>
        <bx-table-header-cell>Status</bx-table-header-cell>
        <bx-table-header-cell>Actions</bx-table-header-cell>
      </bx-table-header-row>
    </bx-table-head>
    <bx-table-body>
      {% for api_key in api_keys.items -%}
      <bx-table-row>
        <bx-table-cell>{{ api_key.name }}</bx-table-cell>
        <bx-table-cell><code>{{ api_key.key_prefix }}...</code></bx-table-cell>
        <bx-table-cell>
          {% for permission in api_key.permissions %}
          <bx-tag>{{ permission }}</bx-tag>
          {% endfor %}
        </bx-table-cell>
        <bx-table-cell>{{ api_key.created_at.strftime('%Y-%m-%d') }}</bx-table-cell>
        <bx-table-cell>
          {% if api_key.expires_at %}
            {{ api_key.expires_at.strftime('%Y-%m-%d') }}
          {% else %}
            Never
          {% endif %}
        </bx-table-cell>
        <bx-table-cell>
          {% if api_key.last_used_at %}
            {{ api_key.last_used_at.strftime('%Y-%m-%d %H:%M') }}
          {% else %}
            Never
          {% endif %}
        </bx-table-cell>
        <bx-table-cell>
          {% if api_key.revoked_at %}
            <bx-tag type="red">Revoked</bx-tag>
          {% else %}
            <bx-tag type="green">Active</bx-tag>
          {% endif %}
        </bx-table-cell>
        <bx-table-cell>
          {% if not api_key.revoked_at %}
          <div class="apollo-actions-row">
            <form method="post" action="{{ api_key.id }}/revoke" style="display:inline;">
              <button type="submit"
                      class="bx--btn bx--btn--tertiary bx--btn--sm"
                      onclick="return confirm('Are you sure you want to revoke this API key? This action cannot be undone.')">
                Revoke
              </button>
            </form>
            <form method="post" action="{{ api_key.id }}/delete" style="display:inline;">
              <button type="submit"
                      class="bx--btn bx--btn--danger bx--btn--sm"
                      onclick="return confirm('Are you sure you want to delete this API key? This action cannot be undone.')">
                Delete
              </button>
            </form>
          </div>
          {% else %}
          <form method="post" action="{{ api_key.id }}/delete" style="display:inline;">
            <button type="submit"
                    class="bx--btn bx--btn--danger bx--btn--sm"
                    onclick="return confirm('Are you sure you want to delete this API key? This action cannot be undone.')">
              Delete
            </button>
          </form>
          {% endif %}
        </bx-table-cell>
      </bx-table-row>
      {% endfor %}
    </bx-table-body>
  </bx-table>
</bx-data-table>

{% if api_keys.items|length == 0 %}
<div class="bx--row" style="margin-top:2rem;">
    <div class="bx--col" style="text-align:center;">
        <p>No API keys found. <a href="new">Create your first API key</a></p>
    </div>
</div>
{% endif %}
        </div>
    </div>
</div>
{% endblock %}